// --- src/handlers/adminCommands.ts ---
// –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
// (—Ç–µ–º, –∫—Ç–æ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É –≤ middleware isAdmin).
// –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∞–¥–º–∏–Ω-–±–æ—Ç–µ (asiancar-rates-admin).

import CurrencyRateModel, { CurrencyCode } from "../models/CurrencyRate.model";
import { Context } from "telegraf";
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤
// import CurrencyRateModel, { CurrencyCode } from "@/models/CurrencyRate.model";
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –æ—à–∏–±–æ–∫), –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
// import { messages } from '@/constants/messages'; // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

// --- –ö–æ–º–∞–Ω–¥–∞ /setrate ---
// –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–∞–ª—é—Ç—ã.
// –û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞ –æ—Ç –∞–¥–º–∏–Ω–∞: /setrate –ö–û–î_–í–ê–õ–Æ–¢–´ –ó–ù–ê–ß–ï–ù–ò–ï_–ö–£–†–°–ê
// –ü—Ä–∏–º–µ—Ä: /setrate EUR 99.50
// –ü—Ä–∏–º–µ—Ä: /setrate KRW 0.071
export const setRateHandler = async (ctx: Context) => {
  // Middleware isAdmin —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.

  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–ª—è command handler —ç—Ç–æ —Ç–∞–∫)
  if (!ctx.message || !("text" in ctx.message)) {
    console.warn("setRateHandler called without text message context.");
    return; // –ù–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã
  }

  // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ –ø—Ä–æ–±–µ–ª—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã
  // ['/setrate', 'KRW', '0.075']
  // slice(1) —É–±–∏—Ä–∞–µ—Ç —Å–∞–º—É –∫–æ–º–∞–Ω–¥—É '/setrate'
  const args = ctx.message.text.split(" ").slice(1);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–Ω–æ —Ä–æ–≤–Ω–æ –¥–≤–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ (–∫–æ–¥ –≤–∞–ª—é—Ç—ã –∏ –∑–Ω–∞—á–µ–Ω–∏–µ)
  if (args.length !== 2) {
    await ctx.replyWithHTML(
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      "<b>–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.</b>\n\n" +
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: <code>/setrate –ö–û–î –ó–ù–ê–ß–ï–ù–ò–ï</code>\n" +
        "<i>–ü—Ä–∏–º–µ—Ä:</i> <code>/setrate KRW 0.075</code>\n\n" +
        "–î–æ–ø—É—Å—Ç–∏–º—ã–µ –∫–æ–¥—ã –≤–∞–ª—é—Ç: <b>KRW, CNY, JPY, EUR</b>"
    );
    return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
  }

  // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–¥ –≤–∞–ª—é—Ç—ã –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
  const code = args[0].toUpperCase() as CurrencyCode; // –ü—Ä–∏–≤–æ–¥–∏–º –∫–æ–¥ –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
  const rateStr = args[1].replace(",", "."); // –ü–æ–∑–≤–æ–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–ø—è—Ç—É—é –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
  const rate = parseFloat(rateStr); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ —á–∏—Å–ª–æ

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞ –≤–∞–ª—é—Ç—ã: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥–∏—Ç –ª–∏ –æ–Ω –≤ —Å–ø–∏—Å–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö
  const allowedCodes: CurrencyCode[] = ["KRW", "CNY", "JPY", "EUR"];
  if (!allowedCodes.includes(code)) {
    await ctx.reply(
      `üö´ –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –≤–∞–ª—é—Ç—ã "<b>${code}</b>".\n` +
        `–î–æ–ø—É—Å—Ç–∏–º—ã–µ –∫–æ–¥—ã: <b>${allowedCodes.join(", ")}</b>`,
      { parse_mode: "HTML" }
    );
    return;
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∫—É—Ä—Å–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
  if (isNaN(rate) || rate <= 0) {
    await ctx.reply(
      `üö´ –ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ "<b>${args[1]}</b>".\n` +
        `–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ (–º–æ–∂–Ω–æ —Å —Ç–æ—á–∫–æ–π –∏–ª–∏ –∑–∞–ø—è—Ç–æ–π).`,
      { parse_mode: "HTML" }
    );
    return;
  }

  // –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
  try {
    console.log(
      `[Admin Bot] Attempting to set rate for ${code} to ${rate} by user ${ctx.from?.id}`
    );

    // –ò—â–µ–º –¥–æ–∫—É–º–µ–Ω—Ç —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–¥–æ–º –≤–∞–ª—é—Ç—ã.
    // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω - –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ 'rate'.
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–¥–æ–º –∏ –∫—É—Ä—Å–æ–º (–±–ª–∞–≥–æ–¥–∞—Ä—è –æ–ø—Ü–∏–∏ upsert: true).
    const updatedRateDoc = await CurrencyRateModel.findOneAndUpdate(
      { code: code }, // –£—Å–ª–æ–≤–∏–µ –ø–æ–∏—Å–∫–∞: –Ω–∞–π—Ç–∏ –ø–æ –∫–æ–¥—É –≤–∞–ª—é—Ç—ã
      { $set: { rate: rate } }, // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞
      {
        upsert: true, // –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω
        new: true, // –í–µ—Ä–Ω—É—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π/—Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç, –∞ –Ω–µ —Å—Ç–∞—Ä—ã–π
        setDefaultsOnInsert: true, // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ —Å—Ö–µ–º—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      }
    ).exec(); // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ upsert –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
    if (!updatedRateDoc) {
      throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –∫—É—Ä—Å–∞ –≤ –ë–î.");
    }

    // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
    console.log(
      `[Admin Bot] Successfully set rate for ${updatedRateDoc.code} to ${updatedRateDoc.rate}. Updated at: ${updatedRateDoc.updatedAt}`
    );

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await ctx.replyWithHTML(
      `‚úÖ –ö—É—Ä—Å –¥–ª—è <b>${updatedRateDoc.code}</b> —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: <b>${updatedRateDoc.rate}</b>\n` +
        `<i>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${updatedRateDoc.updatedAt.toLocaleString(
          "ru-RU"
        )}</i>`
    );
  } catch (error: any) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
    console.error(
      `[Admin Bot] Error setting rate for ${code} by admin ${ctx.from?.id}:`,
      error
    );
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await ctx.reply(
      `‚ùå <b>–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫—É—Ä—Å–∞!</b>\n\n` +
        `<i>–î–µ—Ç–∞–ª–∏: ${
          error.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
        }</i>\n\n` +
        `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.`,
      { parse_mode: "HTML" }
    );
  }
};

// --- –ö–æ–º–∞–Ω–¥–∞ /getrates ---
// –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö —Ç–µ–∫—É—â–∏—Ö –∫—É—Ä—Å–æ–≤, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
export const getRatesHandler = async (ctx: Context) => {
  // Middleware isAdmin —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.
  console.log(`[Admin Bot] User ${ctx.from?.id} requested current rates.`);

  try {
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'currency_rates'
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ –∫–æ–¥—É –≤–∞–ª—é—Ç—ã –¥–ª—è —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
    const rates = await CurrencyRateModel.find().sort({ code: 1 }).exec();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    if (!rates || rates.length === 0) {
      await ctx.reply(
        "‚ö†Ô∏è –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.\n" +
          "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É <code>/setrate –ö–û–î –ó–ù–ê–ß–ï–ù–ò–ï</code> –¥–ª—è –∏—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.",
        { parse_mode: "HTML" }
      );
      return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç —Å –∫—É—Ä—Å–∞–º–∏
    let response = "üìä <b>–¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç (–∫ RUB):</b>\n\n";
    rates.forEach((rateDoc) => {
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–ª—é—Ç—ã
      response +=
        `<b>${rateDoc.code}:</b> ${rateDoc.rate}\n` +
        `   <i>(–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${rateDoc.updatedAt.toLocaleString("ru-RU")})</i>\n`;
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await ctx.replyWithHTML(response);
  } catch (error: any) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    console.error(
      `[Admin Bot] Error fetching rates by admin ${ctx.from?.id}:`,
      error
    );
    await ctx.reply(
      `‚ùå <b>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫—É—Ä—Å–æ–≤!</b>\n\n` +
        `<i>–î–µ—Ç–∞–ª–∏: ${error.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"}</i>`,
      { parse_mode: "HTML" }
    );
  }
};
